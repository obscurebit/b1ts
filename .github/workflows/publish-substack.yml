name: Publish to Substack

on:
  workflow_dispatch:
    inputs:
      edition:
        description: 'Edition number to publish (e.g., 1, 2, 3)'
        required: true
        type: number
      mode:
        description: 'Publish mode'
        required: true
        type: choice
        options:
          - draft
          - publish
        default: draft
      force:
        description: 'Force republish even if already published'
        required: false
        type: boolean
        default: false

permissions:
  contents: write

env:
  SUBSTACK_PUBLICATION_URL: ${{ secrets.SUBSTACK_PUBLICATION_URL }}
  PLAYWRIGHT_STATE: ${{ secrets.PLAYWRIGHT_STATE }}

jobs:
  publish:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install dependencies
        run: |
          pip install openai pyyaml requests playwright python-substack
          playwright install chromium

      - name: Publish Edition to Substack
        run: |
          ARGS="--edition ${{ github.event.inputs.edition }}"
          
          if [ "${{ github.event.inputs.mode }}" = "publish" ]; then
            ARGS="$ARGS --publish"
          else
            ARGS="$ARGS --draft"
          fi
          
          if [ "${{ github.event.inputs.force }}" = "true" ]; then
            ARGS="$ARGS --force"
          fi
          
          echo "Running: python scripts/substack_playwright.py $ARGS"
          python scripts/substack_playwright.py $ARGS

      - name: Upload debug screenshots
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: substack-screenshots
          path: /tmp/substack-*.png
          retention-days: 3

      - name: Commit published marker
        if: ${{ github.event.inputs.mode == 'publish' }}
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add -A
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "ðŸ“° Published edition #${{ github.event.inputs.edition }} to Substack"
            git push
          fi
